<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SYSTEM PD MONARCH</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: url("https://cdn.discordapp.com/attachments/123456789012345678/sapd-bg.jpg") no-repeat center center fixed;
  background-size: cover;
  color: white;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  margin: 0;
  position: relative;
  overflow-y: auto;
}
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  z-index: 0;
  pointer-events: none;
}
.container {
  background-color: rgba(28, 31, 38, 0.9);
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
  width: 400px;
  position: relative;
  z-index: 1;
  backdrop-filter: blur(4px);
  margin-top: 40px;
  margin-bottom: 60px;
}
h2 { text-align: center; color: #3aaefc; text-shadow: 0 0 6px #3aaefc80; }
.tabs { display: flex; justify-content: space-between; margin-bottom: 20px; }
.tab {
  flex: 1; padding: 10px; text-align: center; cursor: pointer;
  background-color: #2a2f3a; border-radius: 8px; margin: 0 3px; transition: 0.2s;
}
.tab:hover { background-color: #3aaefc77; }
.tab.active { background-color: #3aaefc; color: white; font-weight: bold; }
form { display: none; }
form.active { display: block; }
input, textarea, select {
  width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px;
  background-color: #2a2f3a; color: white;
}
button {
  width: 100%; padding: 10px; border: none; border-radius: 8px;
  background-color: #3aaefc; color: white; font-weight: bold; cursor: pointer; transition: 0.2s;
}
button:hover { background-color: #2e8fdc; }
.success, .error {
  text-align: center; margin-top: 10px; font-size: 0.9em;
}
.success { color: #5af77d; }
.error { color: #f75a5a; }
.photo-preview { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
.photo-preview img { width: 110px; height: 110px; object-fit: cover; border-radius: 10px; border: 2px solid #3aaefc; }
#loginArea { text-align: center; margin-bottom: 20px; }
#discordLoginBtn {
  background-color: #5865f2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
}
#discordLoginBtn:hover { background-color: #4752c4; }
.log-list { max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #3aaefc; padding: 6px; border-radius: 6px; font-size: 0.9em; }
.log-item { margin-bottom: 4px; }
</style>
</head>
<body>
<div class="container">
  <h2>LVPD REPORT & CUTI SYSTEM</h2>

  <div id="loginArea">
    <p id="loginText">Silakan login menggunakan Discord untuk melanjutkan.</p>
    <button id="discordLoginBtn">Login dengan Discord</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="tabs">
      <div class="tab active" data-target="dutyForm">Duty</div>
      <div class="tab" data-target="cutiForm">Cuti</div>
      <div class="tab" data-target="loketForm">Loket Pelayanan</div>
    </div>

    <!-- DUTY -->
    <form id="dutyForm" class="active">
      <p style="color:#ffcc00; text-align:center; margin-bottom:10px;">
         Pastikan nama yang tampil adalah <b>In-Character (IC)</b>!
      </p>
      <input type="text" id="officerName" readonly placeholder="Discord Name" />
      <input type="text" id="officerIC" placeholder="Nama IC" required />
      <select id="rank" required>
        <option value="">Pilih Pangkat</option>
        <option value="Constable 1">CONSTABLE 1</option>
        <option value="Officer">SENIOR CONSTABLE</option>
        <option value="Sergeant">LEADING CONSTABLE</option>
        <option value="Lieutenant">SERGENT</option>
        <option value="Captain">DETECTIVE SERGEANT</option>
        <option value="Commander">INSPECTOR</option>
        <option value="Commander">DETECTIVE INSPECTOR</option>
        <option value="Commander">CHIEF INSPECTOR</option>
        <option value="Commander">SUPERINTENDENT</option>
        <option value="Commander">DETECTIVE SUPERINTENDENT</option>
        <option value="Commander">CHIEF SUPERINTDENT</option>
        <option value="Commander">COMANDER</option>
        <option value="Deputy Commissioner">Deputy Commissioner</option>
        <option value="Commissioner">Commissioner</option>
      </select>
      <textarea id="note" placeholder="LIST DUTY 
-
-
-" rows="5" required></textarea>
      <label> Upload 3 Foto Duty</label>
      <input type="file" id="photo1" accept="image/*" required />
      <input type="file" id="photo2" accept="image/*" required />
      <input type="file" id="photo3" accept="image/*" required />
      <div id="photoPreview" class="photo-preview"></div>
      <button type="submit">Kirim Laporan Duty</button>
      <p id="statusDuty"></p>
      <div id="logDuty" class="log-list"></div>
    </form>

    <!-- CUTI -->
    <form id="cutiForm">
      <p style="color:#ffcc00; text-align:center; margin-bottom:10px;">
        Pastikan nama yang tampil adalah <b>In-Character (IC)</b>!
      </p>
      <input type="text" id="officerNameCuti" readonly placeholder="Nama Discord" />
      <input type="text" id="officerICCuti" placeholder="Masukkan Nama In-Character (IC)" required />
      <select id="rankCuti" required>
        <option value="">Pilih Pangkat</option>
        <option value="Constable 1">CONSTABLE 1</option>
        <option value="Officer">SENIOR CONSTABLE</option>
        <option value="Sergeant">LEADING CONSTABLE</option>
        <option value="Lieutenant">SERGENT</option>
        <option value="Captain">DETECTIVE SERGEANT</option>
        <option value="Commander">INSPECTOR</option>
        <option value="Commander">DETECTIVE INSPECTOR</option>
        <option value="Commander">CHIEF INSPECTOR</option>
        <option value="Commander">SUPERINTENDENT</option>
        <option value="Commander">DETECTIVE SUPERINTENDENT</option>
        <option value="Commander">CHIEF SUPERINTDENT</option>
        <option value="Commander">COMANDER</option>
        <option value="Deputy Commissioner">Deputy Commissioner</option>
        <option value="Commissioner">Commissioner</option>
      </select>
      <input type="text" id="tanggalCuti" placeholder="Tanggal Cuti (contoh: 5-7 Nov 2025)" required />
      <textarea id="alasanCuti" placeholder="Alasan cuti..." rows="4" required></textarea>
      <button type="submit">Kirim Laporan Cuti</button>
      <p id="statusCuti"></p>
      <div id="logCuti" class="log-list"></div>
    </form>

    <!-- LOKET PELAYANAN -->
    <form id="loketForm">
      <p style="color:#ffcc00; text-align:center; margin-bottom:10px;">
        Silakan isi form pelayanan!
      </p>
      <input type="text" id="loketName" readonly placeholder="Discord Name" />
      <input type="text" id="loketIC" placeholder="Nama IC" required />
      <select id="loketJenis" required>
        <option value="">Pilih Jenis Pelayanan</option>
        <option value="SIM">SIM</option>
        <option value="SKCK">SKCK</option>
        <option value="Surat Keramaian">Surat Keramaian</option>
        <option value="Plate">Plate</option>
        <option value="Unimpound">Unimpound</option>
      </select>
      <textarea id="loketCatatan" placeholder="Catatan / Permohonan..." rows="4" required></textarea>
      <button type="submit">Kirim Permohonan</button>
      <p id="statusLoket"></p>
      <div id="logLoket" class="log-list"></div>
    </form>
  </div>
</div>

<script>
// === LOGIN DISCORD ===
const clientId = "1434896126242455664";
const redirectUri = "https://police-jaya.vercel.app/";
const scope = "identify email";

document.getElementById("discordLoginBtn").addEventListener("click", () => {
  const oauth2Url = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
  window.location.href = oauth2Url;
});

let loggedUser = null;

const hash = window.location.hash;
if (hash.includes("access_token")) {
  const params = new URLSearchParams(hash.substring(1));
  const token = params.get("access_token");

  fetch("https://discord.com/api/users/@me", { headers: { Authorization: `Bearer ${token}` } })
    .then(res => res.json())
    .then(user => {
      loggedUser = user;
      document.getElementById("loginArea").innerHTML = `
        <p>Login sebagai <b>${user.username}#${user.discriminator}</b></p>
        <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" width="80" style="border-radius:50%; margin-top:10px;">
      `;
      document.getElementById("mainContent").style.display = "block";
      document.getElementById("officerName").value = user.username;
      document.getElementById("officerNameCuti").value = user.username;
      document.getElementById("loketName").value = user.username;
    });
}

// === TAB SWITCH ===
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll("form").forEach(f => f.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

// === PHOTO PREVIEW ===
const photoInputs = [
  document.getElementById("photo1"),
  document.getElementById("photo2"),
  document.getElementById("photo3")
];
const photoPreview = document.getElementById("photoPreview");
photoInputs.forEach(i => i.addEventListener("change", updatePreview));

function updatePreview() {
  photoPreview.innerHTML = "";
  photoInputs.forEach(input => {
    const file = input.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement("img");
        img.src = e.target.result;
        photoPreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  });
}

// === WEBHOOK & THREAD ===
const webhookDuty = "https://discord.com/api/webhooks/1434552675084664982/JK_VY1qdupQwzyKzCabN_KxasyFTHM_85EwIEbW_uUcMcBJsEjKWCuW7LeRSNTLkoQ2d";
const webhookCuti = "https://discord.com/api/webhooks/1434552623356317716/kcdT43fdBkVPxv6sW_oQjtViAfIdYmDIE7gghDaSFz-OBhePfBVGcIhSc_QBdWmU5xLr";
const webhookLoket = "https://discord.com/api/webhooks/1434898452596396224/meK9SFxqOhiB6PpkYsjMecW7MTPaya-xZ35bySgXaWocgpIEX_OWxApw3xgX2P9T7B2L";
let threads = {}; // nanti bisa auto-create thread untuk IC baru

// --- Helper: add log ke halaman ---
function addLog(form, text) {
  const logDiv = document.getElementById(form);
  const item = document.createElement("div");
  item.className = "log-item";
  item.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
  logDiv.prepend(item);
}

// === FORM DUTY ===
document.getElementById("dutyForm").addEventListener("submit", async e => {
  e.preventDefault();
  const status = document.getElementById("statusDuty");
  const ic = document.getElementById("officerIC").value.trim();
  if(!/^[A-Za-z0-9_]{3,20}$/.test(ic)){ status.textContent="❌ Format nama IC salah!"; status.className="error"; return; }

  let threadID = threads[ic];
  if(!threadID){
    // Auto-create thread (Dummy example, di real harus pake bot backend)
    threadID = "AUTO_THREAD_ID_" + ic;
    threads[ic] = threadID;
    addLog("logDuty", `Thread baru dibuat untuk IC ${ic}`);
  }

  const rankVal = document.getElementById("rank").value;
  const noteVal = document.getElementById("note").value;
  const photos = photoInputs.map(i=>i.files[0]).filter(f=>f);
  if(photos.length<3){ status.textContent="⚠️ Upload 3 foto duty!"; status.className="error"; return; }

  const content = `Nama Discord: ${loggedUser.username}\nNama IC: ${ic}\nPangkat: ${rankVal}\nAktifitas:\n${noteVal}`;
  const formData = new FormData();
  formData.append("content", content);
  photos.forEach((p,i)=>formData.append(`file${i+1}`,p));

  try{
    const res = await fetch(`${webhookDuty}?wait=true&thread_id=${threadID}`, { method:"POST", body: formData });
    if(res.ok){ 
      status.textContent="✅ Laporan duty berhasil dikirim!";
      status.className="success";
      e.target.reset();
      photoPreview.innerHTML="";
      addLog("logDuty", `Duty dikirim untuk IC ${ic}`);
    }else{
      status.textContent="❌ Gagal kirim laporan duty.";
      status.className="error";
      addLog("logDuty", `Gagal kirim duty IC ${ic}`);
    }
  }catch(err){ status.textContent="⚠️ Kesalahan jaringan: "+err; status.className="error"; }
});

// === FORM CUTI ===
document.getElementById("cutiForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const status = document.getElementById("statusCuti");
  const ic = document.getElementById("officerICCuti").value.trim();
  if(!ic){ status.textContent="❌ Isi nama IC!"; status.className="error"; return; }

  let threadID = threads[ic];
  if(!threadID){
    threadID = "AUTO_THREAD_ID_" + ic;
    threads[ic] = threadID;
    addLog("logCuti", `Thread baru dibuat untuk IC ${ic}`);
  }

  const rankVal = document.getElementById("rankCuti").value;
  const tanggalVal = document.getElementById("tanggalCuti").value;
  const alasanVal = document.getElementById("alasanCuti").value;

  const embed = {
    title: "Laporan Cuti",
    color: 16753920,
    fields:[
      { name:"Officer Discord", value:loggedUser.username, inline:true },
      { name:"Officer IC", value:ic, inline:true },
      { name:"Pangkat", value:rankVal, inline:true },
      { name:"Tanggal", value:tanggalVal },
      { name:"Alasan", value:alasanVal }
    ],
    footer:{ text: new Date().toLocaleString("id-ID",{timeZone:"Asia/Jakarta"}) }
  };

  try{
    const res = await fetch(`${webhookCuti}?wait=true&thread_id=${threadID}`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ embeds:[embed] })
    });
    if(res.ok){ status.textContent="✅ Laporan cuti berhasil dikirim!"; status.className="success"; e.target.reset(); addLog("logCuti", `Cuti dikirim untuk IC ${ic}`); }
    else { status.textContent="❌ Gagal kirim laporan cuti."; status.className="error"; addLog("logCuti", `Gagal kirim cuti IC ${ic}`); }
  }catch(err){ status.textContent="⚠️ Kesalahan jaringan: "+err; status.className="error"; }
});

// === FORM LOKET ===
document.getElementById("loketForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const status = document.getElementById("statusLoket");
  const ic = document.getElementById("loketIC").value.trim();
  const jenis = document.getElementById("loketJenis").value;
  const catatan = document.getElementById("loketCatatan").value;
  if(!ic || !jenis){ status.textContent="❌ Lengkapi semua form!"; status.className="error"; return; }

  const embed = {
    title: "Permohonan Loket Pelayanan",
    color: 3447003,
    fields:[
      { name:"Officer Discord", value:loggedUser.username, inline:true },
      { name:"Officer IC", value:ic, inline:true },
      { name:"Jenis Pelayanan", value:jenis },
      { name:"Catatan", value:catatan }
    ],
    footer:{ text: new Date().toLocaleString("id-ID",{timeZone:"Asia/Jakarta"}) }
  };

  try{
    const res = await fetch(webhookLoket, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ embeds:[embed] })
    });
    if(res.ok){ status.textContent="✅ Permohonan berhasil dikirim!"; status.className="success"; e.target.reset(); addLog("logLoket", `Permohonan Loket dikirim untuk IC ${ic}`); }
    else{ status.textContent="❌ Gagal kirim permohonan."; status.className="error"; addLog("logLoket", `Gagal kirim permohonan Loket IC ${ic}`); }
  }catch(err){ status.textContent="⚠️ Kesalahan jaringan: "+err; status.className="error"; }
});
</script>
</body>
</html>
